#!/bin/bash

################################################################################
# Odoo 17 Installation Script on Ubuntu 22.04 / 24.04
# Author: Hamza BEKHTI  
################################################################################

# Variables
ODOO_USER="odoo"
ODOO_HOME="/odoo"
ODOO_HOME_EXT="$ODOO_HOME/odoo-server"
ODOO_PORT="8069"
ODOO_VERSION="17.0"

echo "==== Updating system ===="
sudo apt update && sudo apt upgrade -y

echo "==== Installing Dependencies ===="
sudo apt install -y git python3 python3-pip build-essential wget python3-dev \
    python3-venv python3-wheel libxslt-dev libzip-dev libldap2-dev libsasl2-dev \
    python3-setuptools node-less libjpeg-dev libpq-dev gcc g++ python3-polib \
    libxml2-dev libevent-dev libssl-dev libffi-dev

echo "==== Installing and Configuring PostgreSQL ===="
sudo apt install -y postgresql
sudo systemctl enable postgresql
sudo systemctl start postgresql
sudo -u postgres createuser -s $ODOO_USER || true

echo "==== Creating Odoo User and Directories ===="
sudo useradd -m -d $ODOO_HOME -U -r -s /bin/bash $ODOO_USER || true
sudo mkdir -p $ODOO_HOME
sudo chown $ODOO_USER:$ODOO_USER $ODOO_HOME

echo "==== Cloning Odoo $ODOO_VERSION ===="
sudo git clone https://github.com/odoo/odoo.git --branch $ODOO_VERSION --depth 1 $ODOO_HOME_EXT
sudo chown -R $ODOO_USER:$ODOO_USER $ODOO_HOME_EXT

echo "==== Creating Python Virtual Environment ===="
sudo -u $ODOO_USER python3 -m venv $ODOO_HOME/venv
sudo -u $ODOO_USER $ODOO_HOME/venv/bin/pip install --upgrade pip wheel setuptools
sudo -u $ODOO_USER $ODOO_HOME/venv/bin/pip install -r $ODOO_HOME_EXT/requirements.txt

echo "==== Creating Odoo Log Directory ===="
sudo mkdir -p /var/log/odoo
sudo chown $ODOO_USER:$ODOO_USER /var/log/odoo

echo "==== Creating Odoo Configuration File ===="
cat <<EOF | sudo tee /etc/odoo.conf
[options]
   admin_passwd = admin
   db_host = False
   db_port = False
   db_user = $ODOO_USER
   db_password = False
   logfile = /var/log/odoo/odoo.log
   addons_path = $ODOO_HOME_EXT/addons
   xmlrpc_port = $ODOO_PORT
EOF

sudo chown $ODOO_USER:$ODOO_USER /etc/odoo.conf
sudo chmod 640 /etc/odoo.conf

echo "==== Creating Odoo Service File ===="
cat <<EOF | sudo tee /etc/systemd/system/odoo.service
[Unit]
Description=Odoo
Requires=postgresql.service
After=network.target postgresql.service

[Service]
Type=simple
SyslogIdentifier=odoo
PermissionsStartOnly=true
User=$ODOO_USER
Group=$ODOO_USER
ExecStart=$ODOO_HOME/venv/bin/python3 $ODOO_HOME_EXT/odoo-bin -c /etc/odoo.conf
WorkingDirectory=$ODOO_HOME_EXT
StandardOutput=journal+console

[Install]
WantedBy=multi-user.target
EOF

echo "==== Starting and Enabling Odoo Service ===="
sudo systemctl daemon-reexec
sudo systemctl enable --now odoo

echo "==== Odoo $ODOO_VERSION Installation Completed Successfully! ===="
echo "Access it via: http://<server-ip>:$ODOO_PORT"
